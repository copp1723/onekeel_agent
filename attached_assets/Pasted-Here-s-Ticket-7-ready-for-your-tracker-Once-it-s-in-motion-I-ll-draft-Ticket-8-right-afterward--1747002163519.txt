Here‚Äôs Ticket‚ÄØ#7 ready for your tracker. Once it‚Äôs in motion, I‚Äôll draft Ticket‚ÄØ#8 right afterward.

‚∏ª

üéü Ticket‚ÄØ#7: Implement ingestScheduledReport.ts (IMAP Email Ingestion)

Context
Before falling back to Playwright automation, AgentFlow should attempt to fetch CRM reports delivered via scheduled email (e.g., from no-reply@vinsolutions.com). This service connects to a mailbox, scans for new messages, downloads attachments, and returns the file path.

‚∏ª

üìã Requirements
	1.	IMAP Connection
	‚Ä¢	Use imap-simple configured via environment variables:
	‚Ä¢	EMAIL_HOST (e.g. imap.gmail.com)
	‚Ä¢	EMAIL_PORT (e.g. 993)
	‚Ä¢	EMAIL_USER
	‚Ä¢	EMAIL_PASS
	‚Ä¢	EMAIL_TLS (boolean YAML/JSON string)
	‚Ä¢	Connect to INBOX (or configurable folder) and search for unseen messages from the target sender.
	2.	Attachment Handling
	‚Ä¢	For each matched email:
	‚Ä¢	Download all attachments.
	‚Ä¢	Save into envVars.DOWNLOAD_DIR (ensure directory exists).
	‚Ä¢	Generate unique filenames, e.g.

${platform}_${Date.now()}_${originalFilename}


	3.	Post‚ÄëProcessing
	‚Ä¢	Mark each processed message as seen, or move to a ‚Äúprocessed‚Äù folder.
	‚Ä¢	If no new messages found, throw a ReportNotFoundError (or return null, per your preference).
	4.	Return Value
	‚Ä¢	On success: the function resolves with the first downloaded file path (string).
	‚Ä¢	On no report: throws ReportNotFoundError.
	‚Ä¢	On connection/fatal errors: throws with clear, logged error.
	5.	Logging & Errors
	‚Ä¢	Use the shared logger for:
	‚Ä¢	Connection open/close
	‚Ä¢	Number of emails scanned
	‚Ä¢	File paths saved
	‚Ä¢	Wrap IMAP calls in try/catch and propagate errors cleanly.
	6.	Typing & Testing
	‚Ä¢	Signature in src/agents/ingestScheduledReport.ts:

export async function ingestScheduledReport(
  platform: string,
  downloadDir: string
): Promise<string | null>;


	‚Ä¢	Unit tests in src/agents/ingestScheduledReport.test.ts, mocking imap-simple to cover:
	‚Ä¢	No matching emails
	‚Ä¢	Single email, single attachment
	‚Ä¢	Multiple emails/attachments

‚∏ª

‚úÖ Acceptance Criteria
	‚Ä¢	Code compiles cleanly under --strict TS (npx tsc --noEmit).
	‚Ä¢	Successfully connects to IMAP and handles auth errors.
	‚Ä¢	Downloads attachments to DOWNLOAD_DIR with correct naming.
	‚Ä¢	Marks processed messages seen (or moves them).
	‚Ä¢	Returns first file path or throws ReportNotFoundError.
	‚Ä¢	Full unit-test coverage (‚â•‚ÄØ80%).
	‚Ä¢	CI passes (TS + tests).

‚∏ª

üìå Metadata
	‚Ä¢	Assignees: AgentFlow Dev Team
	‚Ä¢	Labels: feature typescript crm-ingestion critical
	‚Ä¢	Branch: feature/ingest-scheduled-report

‚∏ª

Once this is underway, let me know and I‚Äôll hand off Ticket‚ÄØ#8: the hybrid execution (email-first, fallback to runFlow).