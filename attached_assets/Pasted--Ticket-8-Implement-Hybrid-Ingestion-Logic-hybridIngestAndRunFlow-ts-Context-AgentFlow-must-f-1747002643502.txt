üéü Ticket‚ÄØ#8: Implement Hybrid Ingestion Logic (hybridIngestAndRunFlow.ts)

Context
AgentFlow must first attempt email‚Äëbased CRM report ingestion (via ingestScheduledReport). If no report is found (or email ingestion fails with a ‚Äúno report‚Äù error), it should seamlessly fall back to the Playwright‚Äëdriven runFlow browser automation. We need a single entrypoint that orchestrates both paths, logs which route was taken, and returns the downloaded file path.

‚∏ª

üìã Requirements
	1.	Orchestrator Function
	‚Ä¢	Create src/agents/hybridIngestAndRunFlow.ts exporting:

export async function hybridIngestAndRunFlow(
  platform: string,
  envVars: EnvVars
): Promise<string>;


	‚Ä¢	Inside:
	1.	Call ingestScheduledReport(platform, envVars.DOWNLOAD_DIR).
	2.	If it resolves with a non-null path ‚Üí email path taken.
	3.	If it throws ReportNotFoundError (or returns null) ‚Üí call runFlow(platform, envVars).
	4.	Propagate any other errors immediately.

	2.	Logging
	‚Ä¢	Use shared logger to record:
	‚Ä¢	Start time of orchestration.
	‚Ä¢	Which path was taken (email vs. browser).
	‚Ä¢	End time and total duration.
	‚Ä¢	Log error details when falling back or on fatal failure.
	3.	Return Value
	‚Ä¢	Always return the first successfully downloaded file path (string).
	‚Ä¢	Do not swallow fatal errors (e.g., IMAP auth issues, Playwright failures); bubble them up.
	4.	Typing & Tests
	‚Ä¢	Fully type the function under strict TS.
	‚Ä¢	Unit tests in src/agents/hybridIngestAndRunFlow.test.ts, mocking:
	‚Ä¢	ingestScheduledReport to throw ReportNotFoundError ‚Üí expect runFlow to be called.
	‚Ä¢	ingestScheduledReport to return a path ‚Üí expect runFlow not to be called.
	‚Ä¢	Both functions to throw unexpected errors ‚Üí expect error propagation.
	5.	Integration
	‚Ä¢	Update fetchCRMReport.ts (or wherever you centralize ingestion) to call this orchestrator instead of directly calling runFlow.
	‚Ä¢	Ensure CI includes the new tests and TS check.

‚∏ª

‚úÖ Acceptance Criteria
	‚Ä¢	hybridIngestAndRunFlow.ts compiles cleanly under --strict TS.
	‚Ä¢	Correctly orchestrates email-first then browser fallback logic.
	‚Ä¢	Logs path choice and timing details.
	‚Ä¢	Returns valid file path in both success scenarios.
	‚Ä¢	Propagates fatal errors without suppressing.
	‚Ä¢	Unit tests cover all branches with ‚â•‚ÄØ80% coverage.
	‚Ä¢	CI passes (TS + tests).

‚∏ª

üìå Metadata
	‚Ä¢	Assignees: AgentFlow Dev Team
	‚Ä¢	Labels: feature typescript crm-ingestion hybrid-logic
	‚Ä¢	Branch: feature/hybrid-ingest-and-runflow

‚∏ª

Once this ticket is merged, we‚Äôll deep‚Äëdive review Tickets‚ÄØ#7 and‚ÄØ#8 together before moving on to any remaining polish or sample‚Äëfile fixes. Let me know when you‚Äôre ready for that review.