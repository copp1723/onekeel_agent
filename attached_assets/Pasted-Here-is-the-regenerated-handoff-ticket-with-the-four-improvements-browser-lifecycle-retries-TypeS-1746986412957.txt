Here is the regenerated handoff ticket with the four improvements (browser lifecycle, retries, TypeScript signatures, and env var validation) cleanly integrated:

â¸»

Title: Implement Config-Driven Playwright Agent Runner for CRM Report Extraction

â¸»

Overview:

We are replacing hardcoded Playwright flows with a generic, config-driven runner that can execute multi-step login â†’ optional OTP â†’ navigation â†’ report download tasks, using platform-specific JSON configs. This enables support for multiple systems (e.g. VinSolutions, VAUTO) with no code changesâ€”just config updates.

â¸»

âœ… Tasks to Complete

1. Create runFlow.ts Execution Engine

Path: src/agents/runFlow.ts

Implement a generic function:

interface FlowStep {
  action: string;
  selector?: string;
  value?: string;
  args?: string[];
  rowSelector?: string;
  buttonSelector?: string;
  saveAs?: string;
  clickAfter?: string;
}

async function runFlow(platform: string, envVars: Record<string, string>): Promise<string> {
  // Loads platform-specific flow from configs/platforms.json
  // Runs loginSteps, otpStep (if present), navigationSteps, downloadSteps
  // Returns path to downloaded file
}

Required behavior:
	â€¢	Use import config from '../../configs/platforms.json'.
	â€¢	Validate all required envVars are defined before continuing. If any are missing, throw a clear error.
	â€¢	Interpolate {{ENV_VAR_NAME}} placeholders inside step values using the passed-in envVars object.
	â€¢	Implement browser lifecycle inside runFlow:

const browser = await chromium.launch({ headless: true });
const page = await browser.newPage();
// ...run steps...
await browser.close();


	â€¢	Wrap the entire flow in try/catch. On failure, retry once. After a second failure, throw.
	â€¢	Special handling:
	â€¢	If action === 'otpEmail', call your existing getEmailOTP() helper, fill the code, then optionally click clickAfter.
	â€¢	If action === 'download', run:

const row = await page.waitForSelector(rowSelector);
const [download] = await Promise.all([
  page.waitForEvent('download'),
  row.locator(buttonSelector).click()
]);
await download.saveAs(saveAs || 'report.csv');



â¸»

2. Update fetchCRMReport.ts

Replace existing VinSolutions-specific code with a runFlow call:

import { runFlow } from './runFlow';

const filePath = await runFlow("VinSolutions", {
  VIN_SOLUTIONS_USERNAME: process.env.VIN_SOLUTIONS_USERNAME!,
  VIN_SOLUTIONS_PASSWORD: process.env.VIN_SOLUTIONS_PASSWORD!,
  OTP_EMAIL_USER: process.env.OTP_EMAIL_USER!,
  OTP_EMAIL_PASS: process.env.OTP_EMAIL_PASS!
});

Ensure the result (filePath) is returned and/or passed to summarization tools downstream.

â¸»

3. Validate with Both Platforms

Test the following flows:

await runFlow("VinSolutions", {
  VIN_SOLUTIONS_USERNAME: "...",
  VIN_SOLUTIONS_PASSWORD: "...",
  OTP_EMAIL_USER: "...",
  OTP_EMAIL_PASS: "..."
});

await runFlow("VAUTO", {
  VAUTO_USERNAME: "...",
  VAUTO_PASSWORD: "..."
});

Confirm that both succeed from login â†’ (optional OTP) â†’ navigation â†’ download.

â¸»

ðŸ“ File Structure

src/
â”œâ”€â”€ agents/
â”‚   â””â”€â”€ runFlow.ts          âœ… generic multi-step runner
â”‚   â””â”€â”€ fetchCRMReport.ts   âœ… updated to use runFlow
configs/
â””â”€â”€ platforms.json          âœ… defines all flows for VinSolutions and VAUTO


â¸»

ðŸ“Ž Supporting Info

Example Config (from configs/platforms.json)

"VinSolutions": {
  "loginSteps": [
    { "action": "goto", "args": ["https://crm.vinsolutions.com/login"] },
    { "action": "fill", "selector": "#username", "value": "{{VIN_SOLUTIONS_USERNAME}}" },
    { "action": "fill", "selector": "#password", "value": "{{VIN_SOLUTIONS_PASSWORD}}" },
    { "action": "click", "selector": "button[type='submit']" }
  ],
  "otpStep": {
    "action": "otpEmail",
    "selector": "input[name='otp']",
    "clickAfter": "button:has-text('Verify')"
  },
  "navigationSteps": [
    { "action": "click", "selector": "nav >> text=Insights" },
    { "action": "click", "selector": "label:has-text('Most Popular')" }
  ],
  "downloadSteps": [
    {
      "action": "download",
      "rowSelector": "tr:has-text('Dealership Performance Dashboard')",
      "buttonSelector": "button[aria-label='Download']",
      "saveAs": "report.csv"
    }
  ]
}


â¸»

âœ… Acceptance Criteria
	â€¢	runFlow("VinSolutions", ...) and runFlow("VAUTO", ...) execute from config with no hardcoded selectors.
	â€¢	OTP handling works seamlessly with getEmailOTP().
	â€¢	Browser lifecycle is correctly managed (launch â†’ close).
	â€¢	Full flow is retryable on error and throws only after second failure.
	â€¢	Output file path is returned and usable.
	â€¢	Env var validation fails fast and logs missing vars clearly.

â¸»

Let me know once complete so we can wire this into the task executor pipeline.